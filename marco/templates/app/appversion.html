{% extends "/app/av_base.html" %}
{% import "/utils.html" as utils %}

{% block content %}
  <div class="row">
    {% if ptasks %}
      <div class="alert alert-warning" role="alert">
        正在执行任务:
        {% for ptask in ptasks %}
          <p>{{ptask.repr()}}</p>
        {% endfor %}
      </div>
    {% elif app.image_addr %}
      <div class="alert alert-success" role="alert">
        <p>镜像已经构建好, 可以部署了</p>
        <p>镜像地址: {{app.image_addr}}</p>
      </div>
    {% else %}
      <div class="alert alert-success" role="alert">没有正在执行的任务</div>
    {% endif %}
  </div>
  <div class="row row-margin">
    <div class="text-left">
      <form class="form-inline" role="form">
        <div class="form-group">
          <select id="build-host" class="form-control">
            {% for host in hosts %}
            <option value="{{host.id}}">{{host.ip}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <select id="build-base" class="form-control">
            <option value="auto">根据runtime自动选</option>
            <option value="docker-registry.intra.hunantv.com/nbeimage/ubuntu:python-2014.11.28">python-2014.11.28</option>
            <option value="docker-registry.intra.hunantv.com/nbeimage/ubuntu:java-2014.11.28">java-2014.11.28</option>
            <option value="docker-registry.intra.hunantv.com/nbeimage/ubuntu:nodejs-2014.12.1">nodejs-2014.12.1</option>
            <option value="docker-registry.intra.hunantv.com/nbeimage/ubuntu:php-2014.12.18">php-2014.12.18</option>
          </select>
        </div>
        <button type="button" class="btn btn-info btn-build-image" data-url="{{url_for('ajax.app_build_image', app_id=app.id)}}">构建镜像</button>
      </form>
    </div>
  </div>
  <div class="row row-margin">
    <div class="text-left app-block">
      <form class="form-inline" role="form">
        <div class="form-group">
          <select id="add-host" class="form-control">
            {% for host in hosts %}
            <option value="{{host.id}}">{{host.ip}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <select id="add-daemon" class="form-control">
            <option value="false">不用Daemon</option>
            <option value="true">用Daemon跑</option>
          </select>
        </div>
        {% if sub_apps %}
        <div class='form-group'>
            <select id='select-sub-app' class='form-control'>
                <option value=''>{{ app.name }}</option>
                {% for sub_app in sub_apps %}
                    <option value='{{ sub_app.appname }}'>{{ sub_app.appname }}</option>
                {% endfor %}
            </select>
        </div>
        {% else %}
            <input id='select-sub-app' type='hidden' value=''>
        {% endif %}
        <button type="button" class="btn btn-info btn-add-container" data-url="{{url_for('ajax.app_add_container', app_id=app.id)}}">增加容器</button>
      </form>
    </div>
  </div>
  <div class="row row-margin">
    <div class="text-left app-block">
      <button type="button" class="btn btn-info btn-test-app" data-url="{{url_for('ajax.app_test_app', app_id=app.id)}}">测试应用</button>
      <button type="button" class="btn btn-warning btn-remove-container" data-url="{{url_for('ajax.app_remove_app', app_id=app.id)}}">下线应用</button>
      <button type='button' class='btn btn-primary btn-sub-apps'>设定子应用</button>
      <div id='sub-apps-panel' style='display: none'>
          {% if sub_apps %}
          <div style='width: 800px; margin: auto'>
              <div style='font-weight: bolder; font-size: 1.8em; text-align: center'>子应用列表</div>
              {% for sub_app in sub_apps %}
                  <button class='btn btn-info btn-sub-app-show' data-sub='{{ sub_app|tojson }}' style='display: block; float: left; width: 120px; min-height: 4em; margin: 0.5em'>{{ sub_app.appname }}</button>
              {% endfor %}
          </div>
          {% endif %}
          <hr style='clear: both'>
          <table style='margin: auto' id='sub-apps-settings'>
              <caption style='font-weight: bolder; font-size: 1.8em'>设定子应用</caption>
              <tr>
                  <td>
                      子应用名字
                  </td>
                  <td>
                      <label style='font-family: monospace'>{{ app.name }}-</label><input style='height: 30px' type='text' name='subname' id='sub-app-name'>
                      <br>
                      <sup>如果此名字不存在, 则以该名字新建</sup>
                  </td>
              </tr>
              <tr>
                  <td colspan='2'>子应用配置</td>
              </tr>
              <tr>
                  <td>端口</td>
                  <td><input type='text' class='input-block-level' id='sub-app-port' name='port' style='min-width: 500px' value='5000'></td>
              </tr>
              <tr>
                  <td>Runtime</td>
                  <td><input type='text' class='input-block-level' name='runtime' value='{{ app.app_yaml.runtime|e }}'></td>
              </tr>
              <tr>
                  <td>构建</td>
                  <td><textarea class='input-block-level' name='build'>{{ app.app_yaml.build|join_textarea_content|e }}</textarea></td>
              </tr>
              <tr>
                  <td>启动</td>
                  <td><textarea class='input-block-level' name='cmd'>{{ app.app_yaml.cmd|join_textarea_content|e }}</textarea></td>
              </tr>
              <tr>
                  <td>启动 daemon</td>
                  <td><textarea class='input-block-level' name='daemon'>{{ app.app_yaml.daemon|join_textarea_content|e }}</textarea></td>
              </tr>
              <tr>
                  <td>静态文件目录</td>
                  <td><input type='text' class='input-block-level' name='static' value='{{ app.app_yaml.static|e }}'></td>
              </tr>
              <tr>
                  <td><button class='btn btn-primary' id='sub-app-create' data-name='{{ app.name }}' data-version='{{ app.version }}'>设定子应用</button></td>
                  <td><span id='sub-app-error' style='margin-left: 1em'></span></td>
              </tr>
          </table>
      </div>
    </div>
  </div>
  <div class="row row-margin">
    <div class="text-left app-block">
      <button type="button" class="btn btn-info btn-sync-db" data-url="{{url_for('ajax.app_sync_db', app_id=app.id)}}">syncdb</button>
      <button type="button" class="btn btn-info btn-update-app" data-url="{{url_for('ajax.update_app', name=app.name)}}" data-version="{{app.version}}">全部更新到这个版本</button>
    </div>
  </div>
  <div class="row row-margin">
    {{utils.containers_list(app.containers)}}
    <div class="text-right">
      <button class="btn btn-warning btn-collect-all">选择全部</button>
      <button class="btn btn-warning btn-remove-containers disabled" data-url="{{url_for('ajax.remove_containers')}}">下线所选容器</button>
    </div>
  </div>
{% endblock %}

{% block more_css %}
  .row-margin {padding-bottom: 15px;}
  .container-check {position: absolute; border-right: 1px solid #ddd; padding: 0 12px; left: 0;}
{% endblock %}

{% block bottom_script %}
  <script type="text/javascript" src="/marco/static/js/app.js"></script>
{% endblock %}
