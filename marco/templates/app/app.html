{% extends "/base.html" %}
{% import "/utils.html" as utils %}
{% import "/charts.html" as charts %}

{% block title %}
  Marco Applications
{% endblock %}

{% block main_left %}
  <div class="list-group">
    <a class="list-group-item" href="{{url_for('app.app_set_info', name=app.name)}}">所有版本</a>
    <a class="list-group-item" href="{{url_for('app.app_resource', name=app.name, version=app.version)}}">存储</a>
  </div>
  {#{{utils.left_bar(nav.app_sub_nav)}}#}
{% endblock %}

{% block main_right %}

  {#
  <div class="app-block">
    {{charts.chart(app, 'cpu_usage', 'CPU使用率', '.3%')}}
    {{charts.chart(app, 'mem_usage', 'Mem', 'e')}}
    {{charts.chart(app, 'net_recv', 'net_recv')}}
    {{charts.chart(app, 'net_send', 'net_send')}}
  </div>
  #}

  {% if tasks %}
    <div class="list-group">
      <div class="list-group-item list-group-item-info">最近的活动列表</div>
      {% for task in tasks %}
        <a class="list-group-item" href="{{url_for('task.task', task_id=task.id)}}" target="_blank">
          <span class="label label-info">{{task.repr()}}</span>
          {% if task.success() %}
            <span class="label label-success">成功</span>
          {% elif task.processing() %}
            <span class="label label-warning">正在执行...</span>
          {% else %}
            <span class="label label-warning">失败</span>
          {% endif %}
        </a>
      {% endfor %}
    </div>
  {% endif %}

  {% if ptasks %}
    <div class="alert alert-warning" role="alert">
      正在执行任务:
      {% for ptask in ptasks %}
        <p>{{ptask.repr()}}</p>
      {% endfor %}
    </div>
  {% elif app.image_addr %}
    <div class="alert alert-success" role="alert">
      <p>镜像已经构建好, 可以部署了</p>
      <p>镜像地址: {{app.image_addr}}</p>
    </div>
  {% else %}
    <div class="alert alert-success" role="alert">没有正在执行的任务</div>
  {% endif %}

  <div class="text-left">
    <form class="form-inline" role="form">
      <div class="form-group">
        <select id="build-base" class="form-control">
          <option value="docker-registry.intra.hunantv.com/nbeimage/ubuntu:python-2014.9.30">python-2014.9.30</option>
          <option value="docker-registry.intra.hunantv.com/nbeimage/ubuntu:java-2014.10.28">java-2014.10.28</option>
        </select>
      </div>
      <button type="button" class="btn btn-info btn-build-image" data-url="{{url_for('ajax.app_build_image', app_id=app.id)}}">构建镜像</button>
    </form>
  </div>

  <div class="text-left app-block">
    <button type="button" class="btn btn-info btn-test-app" data-url="{{url_for('ajax.app_test_app', app_id=app.id)}}">测试应用</button>
    <button type="button" class="btn btn-info btn-add-container" data-url="{{url_for('ajax.app_add_container', app_id=app.id)}}">增加容器</button>
    <button type="button" class="btn btn-warning btn-remove-container" data-url="{{url_for('ajax.app_remove_app', app_id=app.id)}}">下线应用</button>
  </div>

  <div class="text-left app-block">
    <button type="button" class="btn btn-info btn-sync-db" data-url="{{url_for('ajax.app_sync_db', app_id=app.id)}}">syncdb</button>
    <button type="button" class="btn btn-info btn-update-app" data-url="{{url_for('ajax.update_app', name=app.name)}}" data-version="{{app.version}}">全部更新到这个版本</button>
  </div>

  <div class="app-block">
    {{utils.containers_list(app.containers)}}
  </div>
  <div class="text-right">
    <button class="btn btn-warning btn-collect-all">选择全部</button>
    <button class="btn btn-warning btn-remove-containers disabled" data-url="{{url_for('ajax.remove_containers')}}">下线所选容器</button>
  </div>
{% endblock %}

{% block more_css %}
  .app-block { padding-top: 20px; padding-bottom: 20px; }
  .container-check { position: absolute; border-right: 1px solid #ddd; padding: 0 12px; left: 0; }
{% endblock %}

{% block bottom_script %}
  <script type="text/javascript" src="/marco/static/js/app.js"></script>
  <script type="text/javascript" src="/marco/static/js/charts.js"></script>
{% endblock %}

{% block more_header %}
  <script type="text/javascript" src="/marco/static/js/d3.min.js"></script>
  <script type="text/javascript" src="/marco/static/js/nv.d3.min.js"></script>
  <link rel="stylesheet" type="text/css" media="screen" href="/marco/static/css/nv.d3.min.css">
{% endblock %}

{# vim:set ft=jinja: #}
